name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DEPLOY_TARGET: '/var/www/your-project'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    container:
      image: php:8.2-cli
      options: --user root

    steps:
    - name: Setup Environment
      run: |
        echo "=== Setting up Environment ==="
        
        # Install required packages
        apt-get update
        apt-get install -y git unzip curl nodejs npm
        
        # Install Composer
        curl -sS https://getcomposer.org/installer | php
        mv composer.phar /usr/local/bin/composer
        chmod +x /usr/local/bin/composer
        
        # Verify installations
        php --version
        composer --version
        node --version
        npm --version

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        echo "=== Installing PHP Dependencies ==="
        composer install --no-interaction --optimize-autoloader
        
        echo "=== Installing Node Dependencies ==="
        npm ci

    - name: Build Assets
      run: |
        echo "=== Building Assets ==="
        npm run build

    - name: Run PHP Tests
      continue-on-error: true
      run: |
        echo "=== Running PHP Tests ==="
        if [ -f "vendor/bin/phpunit" ]; then
          vendor/bin/phpunit
        else
          echo "PHPUnit not found, skipping PHP tests"
        fi

    - name: Run JavaScript Tests
      continue-on-error: true
      run: |
        echo "=== Running JavaScript Tests ==="
        if npm list --json | grep -q '"test"'; then
          npm test
        else
          echo "No npm test script found, skipping JS tests"
        fi

    - name: Deploy
      run: |
        echo "=== Deployment Stage ==="
        echo "Project built successfully"
        echo "Files ready for deployment to: ${{ env.DEPLOY_TARGET }}"

    - name: Pipeline Status
      if: always()
      run: |
        echo 'Pipeline execution completed'
        if [ "${{ job.status }}" == "success" ]; then
          echo 'Pipeline executed successfully!'
        else
          echo 'Pipeline failed. Check the logs above for details.'
        fi
